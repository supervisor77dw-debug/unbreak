<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PostMessage Debug Log - UNBREAK ONE</title>
  <script>
    // DEBUG GUARD: Only accessible with debugKey parameter
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const debugKey = urlParams.get('debugKey');
      const validKey = 'messe2026'; // Change for production
      
      if (debugKey !== validKey) {
        document.documentElement.innerHTML = `
          <style>
            body { font-family: monospace; background: #000; color: #0f0; padding: 40px; }
            h1 { color: #f00; }
          </style>
          <body>
            <h1>Access Denied</h1>
            <p>This debug page requires authentication.</p>
            <p>Usage: ?debugKey=&lt;key&gt;</p>
          </body>
        `;
        return;
      }
    })();
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: #fff;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #2F6F55;
      margin-bottom: 10px;
      font-size: 24px;
    }

    .subtitle {
      color: #888;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      background: #2F6F55;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }

    button:hover {
      background: #3d8a6b;
    }

    button.danger {
      background: #c53030;
    }

    button.danger:hover {
      background: #e53e3e;
    }

    .status {
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .status-label {
      color: #888;
    }

    .status-value {
      color: #2F6F55;
      font-weight: bold;
    }

    .empty {
      background: #2a2a2a;
      border: 2px dashed #444;
      border-radius: 4px;
      padding: 40px;
      text-align: center;
      color: #888;
    }

    .message {
      background: #2a2a2a;
      border-left: 4px solid #2F6F55;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
      font-size: 13px;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #444;
    }

    .message-time {
      color: #888;
      font-size: 12px;
    }

    .message-type {
      background: #2F6F55;
      color: white;
      padding: 4px 12px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: bold;
    }

    .message-origin {
      color: #888;
      margin-bottom: 10px;
      font-size: 12px;
    }

    .message-data {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 3px;
      padding: 10px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .highlight {
      color: #ffc107;
      font-weight: bold;
    }

    .error {
      color: #e53e3e;
    }

    .success {
      color: #48bb78;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç PostMessage Debug Log</h1>
    <p class="subtitle">Persistent log of all postMessages received by the shop (survives redirects)</p>

    <div class="controls">
      <button onclick="loadLogs()">üîÑ Refresh</button>
      <button onclick="clearLogs()" class="danger">üóëÔ∏è Clear Logs</button>
      <button onclick="exportLogs()">üì• Export JSON</button>
    </div>

    <div class="status">
      <div class="status-row">
        <span class="status-label">Total Messages:</span>
        <span class="status-value" id="message-count">0</span>
      </div>
      <div class="status-row">
        <span class="status-label">Blocked Messages:</span>
        <span class="status-value error" id="blocked-count">0</span>
      </div>
      <div class="status-row">
        <span class="status-label">Last Updated:</span>
        <span class="status-value" id="last-updated">Never</span>
      </div>
      <div class="status-row">
        <span class="status-label">Storage Key:</span>
        <span class="status-value">unbreak_postmessage_log</span>
      </div>
    </div>

    <div id="logs-container"></div>
    
    <h2 style="margin-top: 40px; color: #e53e3e;">üö´ Blocked Messages (Origin Mismatch)</h2>
    <div id="blocked-container"></div>
  </div>

  <script>
    function loadLogs() {
      const logKey = 'unbreak_postmessage_log';
      const logsRaw = localStorage.getItem(logKey);
      
      const container = document.getElementById('logs-container');
      const countEl = document.getElementById('message-count');
      const updatedEl = document.getElementById('last-updated');

      if (!logsRaw) {
        container.innerHTML = '<div class="empty">No postMessages logged yet.<br><br>Messages will appear here after visiting the configurator page.</div>';
        countEl.textContent = '0';
        updatedEl.textContent = 'Never';
        return;
      }

      let logs;
      try {
        logs = JSON.parse(logsRaw);
      } catch (e) {
        container.innerHTML = '<div class="empty error">Error parsing logs: ' + e.message + '</div>';
        return;
      }

      if (!logs || logs.length === 0) {
        container.innerHTML = '<div class="empty">No postMessages logged yet.</div>';
        countEl.textContent = '0';
        updatedEl.textContent = 'Never';
        return;
      }

      // Update status
      countEl.textContent = logs.length;
      updatedEl.textContent = new Date().toLocaleString('de-DE');

      // Render messages (newest first)
      const html = logs.reverse().map((log, index) => {
        const timestamp = new Date(log.timestamp).toLocaleString('de-DE');
        const messageType = log.event || log.type || 'UNKNOWN';
        const isAddToCart = messageType.includes('ADD_TO_CART') || log.reason === 'add_to_cart';
        const typeClass = isAddToCart ? 'highlight' : '';

        return `
          <div class="message">
            <div class="message-header">
              <div class="message-time">${timestamp}</div>
              <div class="message-type ${typeClass}">${messageType}</div>
            </div>
            <div class="message-origin">Origin: <strong>${log.origin}</strong></div>
            ${log.reason ? `<div class="message-origin">Reason: <strong class="highlight">${log.reason}</strong></div>` : ''}
            <div class="message-data">${JSON.stringify(log.data, null, 2)}</div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    function loadBlockedLogs() {
      const logKey = 'unbreak_blocked_messages';
      const logsRaw = localStorage.getItem(logKey);
      
      const container = document.getElementById('blocked-container');
      const countEl = document.getElementById('blocked-count');

      if (!logsRaw) {
        container.innerHTML = '<div class="empty">No blocked messages</div>';
        countEl.textContent = '0';
        return;
      }

      let logs;
      try {
        logs = JSON.parse(logsRaw);
      } catch (e) {
        container.innerHTML = '<div class="empty error">Error parsing logs: ' + e.message + '</div>';
        return;
      }

      if (!logs || logs.length === 0) {
        container.innerHTML = '<div class="empty">No blocked messages</div>';
        countEl.textContent = '0';
        return;
      }

      // Update count
      countEl.textContent = logs.length;

      // Render messages (newest first)
      const html = logs.reverse().map((log, index) => {
        const timestamp = new Date(log.timestamp).toLocaleString('de-DE');
        const messageType = log.event || log.type || 'UNKNOWN';

        return `
          <div class="message" style="border-left-color: #e53e3e;">
            <div class="message-header">
              <div class="message-time">${timestamp}</div>
              <div class="message-type" style="background: #e53e3e;">${messageType}</div>
            </div>
            <div class="message-origin error">‚ùå BLOCKED Origin: <strong>${log.origin}</strong></div>
            <div class="message-origin">Expected: <strong>${log.expected}</strong></div>
            ${log.reason ? `<div class="message-origin">Reason: <strong>${log.reason}</strong></div>` : ''}
            <div class="message-data">${JSON.stringify(log.data, null, 2)}</div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    function clearLogs() {
      if (!confirm('Are you sure you want to clear all logs?')) return;
      
      localStorage.removeItem('unbreak_postmessage_log');
      localStorage.removeItem('unbreak_blocked_messages');
      loadLogs();
      loadBlockedLogs();
      alert('Logs cleared!');
    }

    function exportLogs() {
      const logKey = 'unbreak_postmessage_log';
      const blockedKey = 'unbreak_blocked_messages';
      const logsRaw = localStorage.getItem(logKey);
      const blockedRaw = localStorage.getItem(blockedKey);
      
      const exportData = {
        accepted: logsRaw ? JSON.parse(logsRaw) : [],
        blocked: blockedRaw ? JSON.parse(blockedRaw) : []
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `postmessage-logs-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Auto-load on page load
    loadLogs();
    loadBlockedLogs();

    // Auto-refresh every 2 seconds
    setInterval(() => {
      loadLogs();
      loadBlockedLogs();
    }, 2000);
  </script>
</body>
</html>
