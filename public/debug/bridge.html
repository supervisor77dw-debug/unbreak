<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bridge Debug / Test Harness</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #0891b2;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #94a3b8;
            margin-bottom: 30px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .panel {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
        }
        .panel h2 {
            color: #0891b2;
            font-size: 16px;
            margin: 0 0 15px 0;
        }
        .iframe-container {
            grid-column: 1 / -1;
            height: 600px;
            background: #1e293b;
            border: 2px solid #0891b2;
            border-radius: 8px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .btn {
            background: #0891b2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 5px 5px 0;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #0e7490;
        }
        .btn-secondary {
            background: #475569;
        }
        .btn-secondary:hover {
            background: #334155;
        }
        .btn-danger {
            background: #ef4444;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .status-item {
            background: #0f172a;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #334155;
        }
        .status-label {
            color: #94a3b8;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .status-value {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: bold;
        }
        .status-value.success {
            color: #10b981;
        }
        .status-value.error {
            color: #ef4444;
        }
        .status-value.warning {
            color: #f59e0b;
        }
        .log-viewer {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #1e293b;
        }
        .log-time {
            color: #64748b;
        }
        .log-stage {
            color: #0891b2;
            font-weight: bold;
        }
        code {
            background: #0f172a;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            color: #f59e0b;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üîç Bridge Debug / Test Harness</h1>
    <p class="subtitle">Test iframe‚Üîparent communication independently</p>

    <!-- Test Controls -->
    <div class="grid">
        <div class="panel">
            <h2>üì§ Send Test Messages</h2>
            <p style="color: #94a3b8; font-size: 12px; margin-bottom: 15px;">Simulate messages FROM iframe TO parent</p>
            
            <button class="btn" onclick="simulateAddToCart()">üõí Simulate ADD_TO_CART</button>
            <button class="btn" onclick="simulateConfigChanged()">üì¶ Simulate CONFIG_CHANGED</button>
            <button class="btn" onclick="simulateIframeReady()">ü§ù Simulate IFRAME_READY</button>
            <button class="btn-secondary btn" onclick="simulateError()">‚ùå Simulate ERROR</button>
            
            <div style="margin-top: 15px;">
                <label style="color: #94a3b8; font-size: 12px;">Custom Event:</label>
                <select id="custom-event" style="width: 100%; padding: 8px; margin: 5px 0; background: #0f172a; color: white; border: 1px solid #334155; border-radius: 4px;">
                    <option value="UNBREAK_ADD_TO_CART">ADD_TO_CART</option>
                    <option value="UNBREAK_CONFIG_CHANGED">CONFIG_CHANGED</option>
                    <option value="UNBREAK_IFRAME_READY">IFRAME_READY</option>
                    <option value="UNBREAK_ACK">ACK</option>
                </select>
                <button class="btn" onclick="sendCustomMessage()">Send Custom</button>
            </div>
        </div>

        <div class="panel">
            <h2>üìä Bridge Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Messages Received</div>
                    <div class="status-value" id="status-received">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Messages Sent</div>
                    <div class="status-value" id="status-sent">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Messages Dropped</div>
                    <div class="status-value warning" id="status-dropped">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Checkout Triggered</div>
                    <div class="status-value" id="status-checkout">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Handshake</div>
                    <div class="status-value" id="status-handshake">pending</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Last Drop Reason</div>
                    <div class="status-value error" id="status-last-drop">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- iframe -->
    <div class="iframe-container">
        <iframe 
            id="configurator-iframe"
            src="https://unbreak-3-d-konfigurator.vercel.app"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
        </iframe>
    </div>

    <!-- Actions -->
    <div class="panel" style="margin-top: 20px;">
        <h2>‚öôÔ∏è Actions</h2>
        <button class="btn" onclick="toggleDebugPanel()">Toggle Debug Panel (Ctrl+Shift+D)</button>
        <button class="btn-secondary btn" onclick="copyDebugDump()">üìã Copy Debug Dump</button>
        <button class="btn-secondary btn" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        <button class="btn-danger btn" onclick="reloadIframe()">üîÑ Reload iframe</button>
    </div>

    <!-- Documentation -->
    <div class="panel" style="margin-top: 20px;">
        <h2>üìñ Message Schema v1.0</h2>
        <p style="color: #94a3b8; font-size: 12px;">All messages must follow this structure:</p>
        <pre style="background: #0f172a; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 11px;"><code>{
  "event": "UNBREAK_ADD_TO_CART",
  "schemaVersion": "1.0",
  "correlationId": "msg_1234567890_abc123",
  "timestamp": "2026-01-09T12:00:00.000Z",
  "payload": {
    "variant": "glass_holder",
    "sku": "UNBREAK-GLAS-01",
    "colors": { "base": "mint", "arm": "darkBlue", "module": "black", "pattern": "red" },
    "finish": "matte",
    "quantity": 1,
    "locale": "de"
  }
}</code></pre>
    </div>
</div>

<!-- Load Bridge System -->
<script src="/lib/bridge-schema.js"></script>
<script src="/lib/bridge-debug.js"></script>
<script src="/lib/bridge-debug-panel.js"></script>

<!-- Load Checkout System (needed for ADD_TO_CART) -->
<script src="/lib/checkout.js"></script>
<script src="/checkout.js"></script>

<script src="/iframe-language-bridge-v2.js?v=2.1.0"></script>

<!-- Test Functions -->
<script>
// Diagnostic: Check what's loaded
console.log('üîç [DIAGNOSTIC] Checking loaded objects...');
console.log('  - window.UnbreakCheckout:', typeof window.UnbreakCheckout);
console.log('  - window.UnbreakCheckout.createCheckoutSession:', typeof window.UnbreakCheckout?.createCheckoutSession);
console.log('  - window.BridgeMessage:', typeof window.BridgeMessage);
console.log('  - window.UnbreakBridgeDebug:', typeof window.UnbreakBridgeDebug);

// Enable debug mode
window.UnbreakBridgeDebug.enable();

// Update status display
function updateStatus() {
    if (!window.UnbreakBridgeDebug) return;
    
    const stats = window.UnbreakBridgeDebug.stats;
    document.getElementById('status-received').textContent = stats.messagesReceived;
    document.getElementById('status-sent').textContent = stats.messagesSent;
    document.getElementById('status-dropped').textContent = stats.messagesDropped;
    document.getElementById('status-checkout').textContent = stats.checkoutTriggered;
    
    const handshake = window.iframeBridge?.isHandshakeComplete();
    const handshakeEl = document.getElementById('status-handshake');
    handshakeEl.textContent = handshake ? 'complete' : 'pending';
    handshakeEl.className = 'status-value ' + (handshake ? 'success' : 'warning');
    
    const lastDrop = window.UnbreakBridgeDebug.lastDropReason;
    if (lastDrop) {
        document.getElementById('status-last-drop').textContent = lastDrop.reason;
    }
}

// Update status every second
setInterval(updateStatus, 1000);

// Test functions
function simulateAddToCart() {
    const message = new window.UnbreakBridge.BridgeMessage('UNBREAK_ADD_TO_CART', {
        variant: 'glass_holder',
        sku: 'UNBREAK-GLAS-01',
        colors: {
            base: 'mint',
            arm: 'darkBlue',
            module: 'black',
            pattern: 'red'
        },
        finish: 'matte',
        quantity: 1,
        locale: 'de',
        pricing: {
            basePrice: 4900,
            totalPrice: 4900
        }
    });
    
    // Simulate message from iframe
    window.postMessage(message.toJSON(), window.location.origin);
    console.log('[TEST] Simulated ADD_TO_CART message');
}

function simulateConfigChanged() {
    const message = new window.UnbreakBridge.BridgeMessage('UNBREAK_CONFIG_CHANGED', {
        variant: 'glass_holder',
        colors: {
            base: 'green',
            arm: 'purple',
            module: 'black',
            pattern: 'iceBlue'
        },
        finish: 'matte',
        quantity: 1
    });
    
    window.postMessage(message.toJSON(), window.location.origin);
    console.log('[TEST] Simulated CONFIG_CHANGED message');
}

function simulateIframeReady() {
    const message = new window.UnbreakBridge.BridgeMessage('UNBREAK_IFRAME_READY', {
        iframeVersion: '1.0.0',
        supportedSchemaVersion: '1.0',
        supportedLocales: ['de', 'en']
    });
    
    window.postMessage(message.toJSON(), window.location.origin);
    console.log('[TEST] Simulated IFRAME_READY message');
}

function simulateError() {
    const message = new window.UnbreakBridge.BridgeMessage('UNBREAK_ERROR', {
        code: 'TEST_ERROR',
        message: 'This is a test error message',
        details: { test: true }
    });
    
    window.postMessage(message.toJSON(), window.location.origin);
    console.log('[TEST] Simulated ERROR message');
}

function sendCustomMessage() {
    const event = document.getElementById('custom-event').value;
    const message = new window.UnbreakBridge.BridgeMessage(event, {
        test: true,
        timestamp: new Date().toISOString()
    });
    
    window.postMessage(message.toJSON(), window.location.origin);
    console.log('[TEST] Sent custom message:', event);
}

function toggleDebugPanel() {
    if (window.UnbreakDebugPanelUI) {
        window.UnbreakDebugPanelUI.toggle();
    }
}

function copyDebugDump() {
    if (window.UnbreakBridgeDebug) {
        window.UnbreakBridgeDebug.copyDump();
    }
}

function clearLogs() {
    if (window.UnbreakBridgeDebug) {
        window.UnbreakBridgeDebug.clear();
    }
    updateStatus();
}

function reloadIframe() {
    const iframe = document.getElementById('configurator-iframe');
    iframe.src = iframe.src;
    console.log('[TEST] iframe reloaded');
}

// Show debug panel on load
setTimeout(() => {
    if (window.UnbreakDebugPanelUI) {
        window.UnbreakDebugPanelUI.show();
    }
}, 500);
</script>

</body>
</html>
