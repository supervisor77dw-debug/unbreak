// UNBREAK ONE - Admin System Schema
// Prisma ORM for Order/Customer/Ticket/User Management

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =====================================================
// AUTH & RBAC
// =====================================================

enum Role {
  ADMIN      // Full access: products, system, users
  STAFF      // Orders, fulfillment, refunds
  SUPPORT    // Tickets, communication, notes


}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String?
  passwordHash String
  role         Role     @default(SUPPORT)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ticketMessages TicketMessage[]



  @@map("admin_users")


}

// =====================================================
// CUSTOMERS
// =====================================================

model Customer {
  id          String    @id @default(uuid())
  email       String    @unique
  name        String?
  phone       String?
  locale      String?   @default("de")
  lastOrderAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  orders  Order[]
  tickets Ticket[]



  @@map("admin_customers")


}

// =====================================================
// ORDERS & ITEMS
// =====================================================

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED


}

enum FulfillmentStatus {
  NEW
  PROCESSING
  SHIPPED
  DONE
  CANCELED


}

model Order {
  id                      String            @id @default(uuid())
  stripeCheckoutSessionId String            @unique @map("stripe_checkout_session_id")
  stripePaymentIntentId   String?           @unique @map("stripe_payment_intent_id")
  statusPayment           PaymentStatus     @default(PENDING) @map("status_payment")
  statusFulfillment       FulfillmentStatus @default(NEW) @map("status_fulfillment")
  currency                String            @default("EUR")
  amountTotal             Int               @map("amount_total") // cents
  amountShipping          Int               @default(0) @map("amount_shipping") // cents
  amountTax               Int               @default(0) @map("amount_tax") // cents
  shippingName            String?           @map("shipping_name")
  shippingAddress         Json?             @map("shipping_address")
  billingAddress          Json?             @map("billing_address")
  email                   String
  customerId              String            @map("customer_id")
  createdAt               DateTime          @default(now()) @map("created_at")
  updatedAt               DateTime          @updatedAt @map("updated_at")
  paidAt                  DateTime?         @map("paid_at")
  shippedAt               DateTime?         @map("shipped_at")
  notes                   String?

  customer Customer      @relation(fields: [customerId], references: [id])
  items    OrderItem[]
  events   OrderEvent[]
  tickets  Ticket[]
  refunds  Refund[]



  @@index([customerId])
  @@index([statusPayment])
  @@index([statusFulfillment])
  @@index([createdAt])
  @@map("admin_orders")


}

model OrderItem {
  id         String @id @default(uuid())
  orderId    String @map("order_id")
  sku        String?
  name       String
  variant    String?
  qty        Int
  unitPrice  Int    @map("unit_price") // cents
  totalPrice Int    @map("total_price") // cents

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)



  @@index([orderId])
  @@map("admin_order_items")


}

// =====================================================
// ORDER EVENT LOG
// =====================================================

enum EventType {
  STRIPE_WEBHOOK
  RESEND_SEND
  STATUS_CHANGE
  NOTE_ADDED
  ERROR


}

model OrderEvent {
  id        String    @id @default(uuid())
  orderId   String?   @map("order_id")
  type      EventType
  source    String    // 'stripe', 'resend', 'admin', 'system'
  payload   Json
  createdAt DateTime  @default(now()) @map("created_at")

  order Order? @relation(fields: [orderId], references: [id], onDelete: Cascade)



  @@index([orderId])
  @@index([type])
  @@index([createdAt])
  @@map("admin_order_events")


}

// =====================================================
// TICKETS & MESSAGES
// =====================================================

enum TicketType {
  COMPLAINT
  RETURN
  QUESTION
  OTHER


}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED


}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT


}

model Ticket {
  id         String         @id @default(uuid())
  orderId    String?        @map("order_id")
  customerId String         @map("customer_id")
  type       TicketType     @default(QUESTION)
  status     TicketStatus   @default(OPEN)
  priority   TicketPriority @default(NORMAL)
  subject    String
  message    String
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")

  order    Order?          @relation(fields: [orderId], references: [id], onDelete: SetNull)
  customer Customer        @relation(fields: [customerId], references: [id])
  messages TicketMessage[]



  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@index([priority])
  @@map("admin_tickets")


}

model TicketMessage {
  id                  String   @id @default(uuid())
  ticketId            String   @map("ticket_id")
  authorUserId        String?  @map("author_user_id")
  authorCustomerEmail String?  @map("author_customer_email")
  body                String
  createdAt           DateTime @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author User?  @relation(fields: [authorUserId], references: [id])



  @@index([ticketId])
  @@map("admin_ticket_messages")


}

// =====================================================
// REFUNDS
// =====================================================

enum RefundStatus {
  REQUESTED
  SUBMITTED
  SUCCEEDED
  FAILED


}

model Refund {
  id             String       @id @default(uuid())
  orderId        String       @map("order_id")
  stripeRefundId String?      @unique @map("stripe_refund_id")
  amount         Int          // cents
  reason         String?
  status         RefundStatus @default(REQUESTED)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)



  @@index([orderId])
  @@index([status])
  @@map("admin_refunds")


}

// =====================================================
// PRODUCTS (Shop & Configurator)
// =====================================================

model Product {
  id              String    @id @default(uuid())
  sku             String    @unique
  name            String
  description     String?
  basePriceCents  Int       @map("base_price_cents")
  active          Boolean   @default(true)
  imagePath       String?   @map("image_path")      // Supabase Storage: products/<sku>/main.jpg (Original)
  imageUrl        String?   @map("image_url")       // Public URL (cached, Original)
  imageUpdatedAt  DateTime? @map("image_updated_at") // Cache-Buster: Timestamp des letzten Image-Uploads
  thumbPath       String?   @map("thumb_path")      // Server-generated Thumbnail (240x300, 4:5, mit Crop)
  shopImagePath   String?   @map("shop_image_path") // Server-generated Shop Image (800x1000, 4:5, mit Crop)
  imageCropScale  Float?    @default(1.0) @map("image_crop_scale") // Zoom: 1.0 - 2.5
  imageCropX      Int?      @default(0) @map("image_crop_x")       // X offset: -200 to +200
  imageCropY      Int?      @default(0) @map("image_crop_y")       // Y offset: -200 to +200
  badgeLabel      String?   @map("badge_label")     // e.g. "Gastro Edition" (max 20 chars)
  shippingText    String?   @map("shipping_text")   // e.g. "Versand 3â€“5 Tage"
  highlights      Json?                              // JSONB array of USPs
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("products")
}
